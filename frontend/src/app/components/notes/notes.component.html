<div class="notes-page">
  <h2>Notas</h2>

  <div class="notes-filters-bar">
    <input type="text" [(ngModel)]="filterText" placeholder="Buscar por título" class="notes-filter-input" />
    <input type="text" [(ngModel)]="filterClient" placeholder="Buscar por cliente" class="notes-filter-input" />
    <input type="date" [(ngModel)]="filterDate" class="notes-filter-input" />
    <select [(ngModel)]="sortOrder" class="notes-filter-input">
      <option value="desc">Más recientes</option>
      <option value="asc">Más antiguos</option>
    </select>
    <button (click)="clearFilters()" class="notes-filter-clear">Limpiar</button>
  </div>

  <div *ngIf="loading" class="loading">Cargando notas...</div>
  <div *ngIf="error" class="error">{{ error }}</div>

  <div class="notes-list-section">
    <div *ngIf="filteredNotes.length === 0 && !loading" class="notes-empty">No hay notas que coincidan.</div>
    <div class="notes-grid" *ngIf="filteredNotes.length > 0">
      <div class="note-card" *ngFor="let clientKey of (filteredGroupedNotes | keyvalue)">
        <div class="note-card-header" (click)="toggleClient(clientKey.key)" style="cursor:pointer;">
          <div class="note-avatar">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M6 20v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2"/></svg>
          </div>
          <div class="note-title-meta">
            <strong>{{ clientKey.key }}</strong>
            <span class="note-count">({{ clientKey.value.length }} nota{{ clientKey.value.length > 1 ? 's' : '' }})</span>
          </div>
          <div class="expand-icon" [class.expanded]="isExpanded(clientKey.key)">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
          </div>
        </div>
        <div *ngIf="isExpanded(clientKey.key) && clientKey.value.length > 0" class="note-group-list">
          <div class="note-card-content" *ngFor="let note of clientKey.value">
            <div class="note-title-row">
              <strong>{{ note.title }}</strong>
              <small *ngIf="note.tag">#{{ note.tag }}</small>
            </div>
            <div class="note-content">{{ note.content }}</div>
            <div class="note-meta">
              <span>{{ note.created_at | date:'short' }}</span>
            </div>
            <hr *ngIf="note !== clientKey.value[clientKey.value.length-1]" />
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
